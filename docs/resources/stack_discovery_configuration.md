---
page_title: "cm_stack_discovery_configuration Resource - terraform-provider-cm"
subcategory: ""
description: |-
  Creates, updates and destroys stack discovery configurations. For more information: ControlMonkey Documentation https://docs.controlmonkey.io/main-concepts/stack/stack-auto-discovery
---

# cm_stack_discovery_configuration (Resource)

Creates, updates and destroys stack discovery configurations. For more information: [ControlMonkey Documentation](https://docs.controlmonkey.io/main-concepts/stack/stack-auto-discovery)

Stack Auto-Discovery in ControlMonkey enables automatic detection and registration of infrastructure stacks based on Git repository structure. When folders or paths containing Terraform code are added to a repository, ControlMonkey can automatically create and manage corresponding stacks, integrating them into the infrastructure CI/CD process.

Stack Auto-Discovery is triggered by:
- Opening or updating a Pull Request (PR)
- Pushing directly to the main branch

## Learn more

- [Automatic Detection and Creation of Terraform Stacks](https://controlmonkey.io/news/automatic-detection-and-creation-of-terraform-stacks/)
- [Exclude Folders or Paths from Stack Auto-Discovery](https://controlmonkey.io/news/exclude-folders-or-paths-from-stack-auto-discovery/)
- [Terraform CI/CD Showdown: DIY or Buy?](https://controlmonkey.io/blog/terraform-diy-vs-buy/)

## Example Usage

```terraform
data "cm_namespace" "namespace" {
  name = "Production"
}

resource "cm_stack_discovery_configuration" "example" {
  name         = "Terraform Stack Discovery"
  namespace_id = data.cm_namespace.namespace.id
  description  = "Auto-discover and manage Terraform stacks in production repositories"

  vcs_patterns = [
    {
      provider_id = "vcsp-abc123"
      repo_name   = "my-org/infrastructure"
      path_patterns = ["environments/*/terraform/**", "modules/*/**"]
      exclude_path_patterns = ["**/test/**", "**/.terraform/**"]
      branch      = "main"
    }
  ]

  stack_config = {
    iac_type = "terraform"

    deployment_behavior = {
      deploy_on_push = false
    }

    deployment_approval_policy = {
      rules = [
        {
          type = "requireTwoApprovals"
        }
      ]
    }

    iac_config = {
      terraform_version = "1.5.5"
    }

    runner_config = {
      mode = "managed"
    }

    auto_sync = {
      deploy_when_drift_detected = true
    }
  }
}
```

### With Multiple VCS Patterns and Self-Hosted Runners

```terraform
resource "cm_namespace" "dev_namespace" {
  name        = "Development"
  description = "Development environment namespace"
}

resource "cm_stack_discovery_configuration" "dev_discovery" {
  name         = "Development Stack Discovery"
  namespace_id = cm_namespace.dev_namespace.id
  description  = "Auto-discover development stacks with self-hosted runners"

  vcs_patterns = [
    {
      provider_id = "vcsp-def456"
      repo_name   = "my-org/dev-infrastructure"
      path_patterns = ["apps/*/terraform/**", "services/*/infra/**"]
      exclude_path_patterns = ["**/node_modules/**", "**/vendor/**"]
      branch      = "develop"
    },
    {
      provider_id = "vcsp-def456"
      repo_name   = "my-org/microservices"
      path_patterns = ["**/infrastructure/**"]
      branch      = "main"
    }
  ]

  stack_config = {
    iac_type = "terraform"

    deployment_behavior = {
      deploy_on_push = true
    }

    iac_config = {
      terraform_version = "1.5.5"
    }

    runner_config = {
      mode = "selfHosted"
      groups = ["dev-runners", "shared-runners"]
    }

    auto_sync = {
      deploy_when_drift_detected = false
    }
  }
}
```

<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `name` (String) The name of the stack discovery configuration.
- `namespace_id` (String) The namespace ID where the stack discovery configuration is located.
- `stack_config` (Attributes) The stack configuration template for discovered stacks. (see [below for nested schema](#nestedatt--stack_config))
- `vcs_patterns` (Attributes List) The VCS patterns configuration for stack discovery. (see [below for nested schema](#nestedatt--vcs_patterns))

### Optional

- `description` (String) The description of the stack discovery configuration.

### Read-Only

- `id` (String) The unique ID of the stack discovery configuration.

<a id="nestedatt--stack_config"></a>
### Nested Schema for `stack_config`

Required:

- `deployment_behavior` (Attributes) The deployment behavior configuration. (see [below for nested schema](#nestedatt--stack_config--deployment_behavior))
- `iac_type` (String) IaC type of the stack. Allowed values: [terraform, terragrunt, opentofu].

Optional:

- `auto_sync` (Attributes) Set up auto sync configurations. (see [below for nested schema](#nestedatt--stack_config--auto_sync))
- `deployment_approval_policy` (Attributes) Set up requirements to approve a deployment (see [below for nested schema](#nestedatt--stack_config--deployment_approval_policy))
- `iac_config` (Attributes) IaC configuration. (see [below for nested schema](#nestedatt--stack_config--iac_config))
- `run_trigger` (Attributes) Glob patterns to specify additional paths that should trigger a stack run. (see [below for nested schema](#nestedatt--stack_config--run_trigger))
- `runner_config` (Attributes) Configure the runner settings to specify whether ControlMonkey manages the runner or it is self-hosted. (see [below for nested schema](#nestedatt--stack_config--runner_config))

<a id="nestedatt--stack_config--deployment_behavior"></a>
### Nested Schema for `stack_config.deployment_behavior`

Required:

- `deploy_on_push` (Boolean) Choose whether to initiate a deployment when a push event occurs or not.

Optional:

- `wait_for_approval` (Boolean, Deprecated) Use `deployment_approval_policy`. Decide whether to wait for approval before proceeding with the deployment or not.


<a id="nestedatt--stack_config--auto_sync"></a>
### Nested Schema for `stack_config.auto_sync`

Optional:

- `deploy_when_drift_detected` (Boolean) If set to `true`, a deployment will start automatically upon detecting a drift or multiple drifts


<a id="nestedatt--stack_config--deployment_approval_policy"></a>
### Nested Schema for `stack_config.deployment_approval_policy`

Required:

- `rules` (Attributes List) Set up rules for approving deployment processes. At least one rule should be configured (see [below for nested schema](#nestedatt--stack_config--deployment_approval_policy--rules))

<a id="nestedatt--stack_config--deployment_approval_policy--rules"></a>
### Nested Schema for `stack_config.deployment_approval_policy.rules`

Required:

- `type` (String) The type of the rule. Find supported types [here](https://docs.controlmonkey.io/controlmonkey-api/api-enumerations#deployment-approval-policy-rule-types)

Optional:

- `parameters` (String) JSON format of the rule parameters according to the `type`. Find supported parameters [here](https://docs.controlmonkey.io/controlmonkey-api/approval-policy-rules)



<a id="nestedatt--stack_config--iac_config"></a>
### Nested Schema for `stack_config.iac_config`

Optional:

- `is_terragrunt_run_all` (Boolean) When using terragrunt, as long as this field is set to `True`, this field will execute "run-all" commands on multiple modules for init/plan/apply
- `opentofu_version` (String) the OpenTofu version that will be used for tofu operations.
- `terraform_version` (String) the Terraform version that will be used for terraform operations.
- `terragrunt_version` (String) the Terragrunt version that will be used for terragrunt operations.
- `var_files` (List of String) Custom variable files to pass on to Terraform. For more information: [ControlMonkey Docs](https://docs.controlmonkey.io/main-concepts/stack/stack-settings#var-files)


<a id="nestedatt--stack_config--run_trigger"></a>
### Nested Schema for `stack_config.run_trigger`

Optional:

- `exclude_patterns` (List of String) Patterns that will not trigger a stack run.
- `patterns` (List of String) Patterns that trigger a stack run.


<a id="nestedatt--stack_config--runner_config"></a>
### Nested Schema for `stack_config.runner_config`

Required:

- `mode` (String) The runner mode. Allowed values: [managed, selfHosted].

Optional:

- `groups` (List of String) In case that `mode` is `selfHosted`, groups must contain at least one runners group. If `mode` is `managed`, this field must not be configured.



<a id="nestedatt--vcs_patterns"></a>
### Nested Schema for `vcs_patterns`

Required:

- `branch` (String) The branch to monitor for stack discovery.
- `path_patterns` (List of String) List of path patterns to include for stack discovery.
- `provider_id` (String) The ControlMonkey unique ID of the connected version control system.
- `repo_name` (String) The name of the version control repository.

Optional:

- `exclude_path_patterns` (List of String) List of path patterns to exclude from stack discovery.

## Import

`cm_stack_discovery_configuration` can be imported using the ID of the Stack Discovery Configuration, e.g.

```shell
terraform import cm_stack_discovery_configuration.example sdc-123456789
```
