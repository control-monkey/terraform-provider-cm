---
page_title: "cm_stack Resource - terraform-provider-cm"
subcategory: ""
description: |-
  Creates, updates and destroys stacks.
---

# cm_stack (Resource)

Creates, updates and destroys stacks.

## Learn More

- [Terraform CI/CD Showdown: DIY or Buy?](https://controlmonkey.io/blog/terraform-diy-vs-buy/)
- [Running Terraform with Jenkins: Pros and Cons](https://controlmonkey.io/blog/running-terraform-with-jenkins/)
- [Build a Terraform CI/CD Pipeline on AWS](https://controlmonkey.io/blog/terraform-ci-cd-pipeline-aws/)
- [Detect When the Same Terraform Resource Is Managed in Multiple Files](https://controlmonkey.io/news/same-terraform-resource-multiple-files/)

## Example Usage

### Simple stack
```terraform
resource "cm_stack" "auto_scaling_group_dev" {
  name         = "dev/auto-scaling-group"
  description  = "Auto Scaling Group Stack"
  namespace_id = cm_namespace.dev_namespace.id
  iac_type     = "terraform"

  deployment_behavior = {
    deploy_on_push = true
  }

  vcs_info = {
    provider_id = "vcsp-123"
    repo_name   = "terraform"
    path        = "dev/auto-scaling-group"
  }
}
```

### Stack that requires two different users to approve a deployment. Also, when a new drift is detected, a deployment will be starting automatically and will also wait for 2 approvals.
```terraform
resource "cm_stack" "auto_scaling_group_dev" {
  name         = "dev/auto-scaling-group"
  description  = "Auto Scaling Group Stack"
  namespace_id = cm_namespace.dev_namespace.id
  iac_type     = "terraform"

  deployment_behavior = {
    deploy_on_push = true
  }

  vcs_info = {
    provider_id = "vcsp-123"
    repo_name   = "terraform"
  }

  deployment_approval_policy = {
    rules = [
      {
        type = "requireTwoApprovals"
      }
    ]
  }

  auto_sync = {
    deploy_when_drift_detected = true
  }
}
```

### Stack that is configured to use a specific terraform version. Also configured with a TTL to run only 3 hours.
```terraform
resource "cm_stack" "auto_scaling_group_dev" {
  name         = "dev/auto-scaling-group"
  description  = "Auto Scaling Group Stack"
  namespace_id = cm_namespace.dev_namespace.id
  iac_type     = "terraform"

  deployment_behavior = {
    deploy_on_push = true
  }

  vcs_info = {
    provider_id = "vcsp-123"
    repo_name   = "terraform"
  }

  iac_config = {
    terraform_version = "1.4.5"
  }

  policy = {
    ttl_config = {
      ttl = {
        type  = "hours"
        value = "3"
      }
    }
  }
}
```

### Stack for which any plan/deployment would also trigger its all sub-directories. This stack's plan/deployment runs are configured to run in a self-hosted runner under the runner-group "dev-runner"
```terraform
resource "cm_stack" "auto_scaling_group_dev" {
  name         = "dev/auto-scaling-group"
  description  = "Auto Scaling Group Stack"
  namespace_id = cm_namespace.dev_namespace.id
  iac_type     = "terraform"

  deployment_behavior = {
    deploy_on_push = true
  }

  vcs_info = {
    provider_id = "vcsp-123"
    repo_name   = "terraform"
    path        = "dev/auto-scaling-group"
  }

  run_trigger = {
    patterns = [
      # matches all files in any sub-directory under the stack's directory.
      # ControlMonkey will replace automatically ${stack_path} with "dev/auto-scaling-group".
      "$${stack_path}/**/*" # '$$' is used to escape the '$' character
    ]
  }

  runner_config = {
    mode = "selfHosted"
    groups = ["dev-runner"]
  }
}
```


<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `deployment_behavior` (Attributes) The deployment behavior configuration. (see [below for nested schema](#nestedatt--deployment_behavior))
- `iac_type` (String) IaC type of the stack. Allowed values: [terraform, terragrunt, opentofu].
- `name` (String) The name of the stack.
- `namespace_id` (String) The namespace ID where the stack is located.
- `vcs_info` (Attributes) The configuration of the version control to which the stack is attached. (see [below for nested schema](#nestedatt--vcs_info))

### Optional

- `auto_sync` (Attributes) Set up auto sync configurations. (see [below for nested schema](#nestedatt--auto_sync))
- `deployment_approval_policy` (Attributes) Set up requirements to approve a deployment (see [below for nested schema](#nestedatt--deployment_approval_policy))
- `description` (String) The description of the stack.
- `iac_config` (Attributes) IaC configuration of the stack. (see [below for nested schema](#nestedatt--iac_config))
- `policy` (Attributes) The policy of the stack. (see [below for nested schema](#nestedatt--policy))
- `run_trigger` (Attributes) Glob patterns to specify additional paths that should trigger a stack run. (see [below for nested schema](#nestedatt--run_trigger))
- `runner_config` (Attributes) Configure the runner settings to specify whether ControlMonkey manages the runner or it is self-hosted. (see [below for nested schema](#nestedatt--runner_config))

### Read-Only

- `id` (String) The unique ID of the stack.

<a id="nestedatt--deployment_behavior"></a>
### Nested Schema for `deployment_behavior`

Required:

- `deploy_on_push` (Boolean) Choose whether to initiate a deployment when a push event occurs or not.

Optional:

- `wait_for_approval` (Boolean, Deprecated) Use `deployment_approval_policy`. Decide whether to wait for approval before proceeding with the deployment or not.


<a id="nestedatt--vcs_info"></a>
### Nested Schema for `vcs_info`

Required:

- `provider_id` (String) The ControlMonkey unique ID of the connected version control system.
- `repo_name` (String) The name of the version control repository.

Optional:

- `branch` (String) The branch that should trigger plan/deployment for the stack. When no branch is given, the default branch of the repository is chosen.
- `path` (String) The path to a chosen directory from the root. Default path is root directory


<a id="nestedatt--auto_sync"></a>
### Nested Schema for `auto_sync`

Optional:

- `deploy_when_drift_detected` (Boolean) If set to `true`, a deployment will start automatically upon detecting a drift or multiple drifts


<a id="nestedatt--deployment_approval_policy"></a>
### Nested Schema for `deployment_approval_policy`

Required:

- `rules` (Attributes List) Set up rules for approving deployment processes. At least one rule should be configured (see [below for nested schema](#nestedatt--deployment_approval_policy--rules))

<a id="nestedatt--deployment_approval_policy--rules"></a>
### Nested Schema for `deployment_approval_policy.rules`

Required:

- `type` (String) The type of the rule. Find supported types [here](https://docs.controlmonkey.io/controlmonkey-api/api-enumerations#deployment-approval-policy-rule-types)

Optional:

- `parameters` (String) JSON format of the rule parameters according to the `type`. Find supported parameters [here](https://docs.controlmonkey.io/controlmonkey-api/approval-policy-rules)



<a id="nestedatt--iac_config"></a>
### Nested Schema for `iac_config`

Optional:

- `is_terragrunt_run_all` (Boolean) When using terragrunt, as long as this field is set to `True`, this field will execute "run-all" commands on multiple modules for init/plan/apply
- `opentofu_version` (String) the OpenTofu version that will be used for OpenTofu operations.
- `terraform_version` (String) the Terraform version that will be used for terraform operations.
- `terragrunt_version` (String) the Terragrunt version that will be used for terragrunt operations.
- `var_files` (List of String) Custom variable files to pass on to Terraform. For more information: [ControlMonkey Docs](https://docs.controlmonkey.io/main-concepts/stack/stack-settings#var-files)


<a id="nestedatt--policy"></a>
### Nested Schema for `policy`

Optional:

- `ttl_config` (Attributes) The time to live config of the stack policy. (see [below for nested schema](#nestedatt--policy--ttl_config))

<a id="nestedatt--policy--ttl_config"></a>
### Nested Schema for `policy.ttl_config`

Required:

- `ttl` (Attributes) (see [below for nested schema](#nestedatt--policy--ttl_config--ttl))

<a id="nestedatt--policy--ttl_config--ttl"></a>
### Nested Schema for `policy.ttl_config.ttl`

Required:

- `type` (String) The type of the ttl. Allowed values: [hours, days].
- `value` (Number) The value that corresponds the type




<a id="nestedatt--run_trigger"></a>
### Nested Schema for `run_trigger`

Optional:

- `exclude_patterns` (List of String) Patterns that will not trigger a stack run.
- `patterns` (List of String) Patterns that trigger a stack run.


<a id="nestedatt--runner_config"></a>
### Nested Schema for `runner_config`

Required:

- `mode` (String) The runner mode. Allowed values: [managed, selfHosted].

Optional:

- `groups` (List of String) In case that `mode` is `selfHosted`, groups must contain at least one runners group. If `mode` is `managed`, this field must not be configured.

## Import

`cm_stack` can be imported using the ID of the Stack, e.g.

```shell
terraform import cm_stack.stack stk-123
```